let products=JSON.parse(localStorage.getItem("products")||"[]"),cart=JSON.parse(localStorage.getItem("cart")||"[]");const updateDate=()=>{document.getElementById("current-date").textContent=new Date().toLocaleString("cs-CZ",{day:"numeric",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit"})};const showToast=(t,e="success")=>{const o=document.getElementById("toast");o.textContent=t,o.className=`toast ${"success"===e?"toast-success":"toast-error"} show`,o.style.display="block",setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.style.display="none",300)},3e3)};const launchPOS=()=>{const t=document.getElementById("landing"),e=document.getElementById("animation-overlay"),o=document.getElementById("pos-container"),n=e.querySelector(".spinner"),a=e.querySelector(".animation-text"),c=document.querySelector(".menu-card"),s=document.querySelector(".cart-card"),d=document.querySelector(".header");t.style.display="none",e.style.display="flex",e.style.animation="bgPulse 7s ease-in-out",setTimeout(()=>{n.style.animation="fadeIn 0.5s forwards, spin 1.5s linear infinite",a.style.animation="fadeIn 0.5s forwards"},500),setTimeout(()=>{n.style.animation="fadeIn 0.5s reverse",a.style.animation="fadeIn 0.5s reverse"},1500),setTimeout(()=>{e.style.display="none",o.classList.remove("pos-hidden"),o.style.animation="fadeIn 1s forwards",d.style.animation="slideDown 1s forwards 0.5s",c.style.animation="slideIn 1s forwards 1s",s.style.animation="slideInRight 1s forwards 1.5s"},2e3),setTimeout(()=>{o.style.opacity="1",o.style.transform="translateY(0)",d.style.opacity="1",d.style.transform="translateY(0)",c.style.opacity="1",c.style.transform="translateX(0)",s.style.opacity="1",s.style.transform="translateX(0)"},6e3)};document.getElementById("launch-pos").addEventListener("click",launchPOS);const displayCategories=()=>{const t=["Vše",...new Set(products.map(t=>t.category))],e=document.getElementById("categories");e.innerHTML=t.map(t=>`<span class="category-tab ${"Vše"===t?"active":""}" data-category="${t}">${t}</span>`).join(""),document.querySelectorAll(".category-tab").forEach(t=>t.addEventListener("click",()=>filterMenu(t.dataset.category))),document.getElementById("product-category").innerHTML='<option value="">Vyberte kategorii</option>'+t.filter(t=>"Vše"!==t).map(t=>`<option value="${t}">${t}</option>`).join("")};const displayMenu=(t="Vše",e="")=>{const o=products.filter(o=>("Vše"===t||o.category===t)&&o.name.toLowerCase().includes(e.toLowerCase()));document.getElementById("menu").innerHTML=o.map(t=>`<div class="item" data-id="${t.id}"><div class="text-container text-adaptive font-medium text-white" data-fulltext="${t.name}">${t.name}</div><div class="flex items-center space-x-4"><span class="text-price text-green-400">${t.price} Kč</span><span class="text-adaptive text-gray-400">${t.category}</span></div></div>`).join(""),document.querySelectorAll(".item").forEach(t=>t.addEventListener("click",()=>{const e=products.find(e=>e.id===+t.dataset.id);e&&(addToCart(e),showToast(`${e.name} přidán do košíku`))}))};const displayProducts=()=>{document.getElementById("product-list").innerHTML=products.length?products.map(t=>`<div class="p-3 border-b bg-gray-700 rounded-lg hover:bg-gray-600 transition"><div class="flex justify-between text-adaptive"><span><strong>${t.name}</strong> (${t.category})</span><span>${t.price} Kč</span></div><div class="flex gap-2 mt-2"><button onclick="editProduct(${t.id})" class="custom-button bg-blue-600 text-white text-sm">Upravit</button><button onclick="deleteProduct(${t.id})" class="custom-button bg-red-600 text-white text-sm">Smazat</button></div></div>`).join(""):'<p class="text-gray-400 text-adaptive">Žádné produkty.</p>'};const addToCart=t=>{const e=cart.find(e=>e.id===t.id);e?e.quantity++:cart.push({...t,quantity:1}),saveCart(),updateCart()};const updateCart=()=>{const t=+document.getElementById("discount").value||0,e=+document.getElementById("tip").value||0;if(t<0||t>100)return showToast("Sleva musí být 0-100%","error"),void(document.getElementById("discount").value="");if(e<0)return showToast("Dýško nemůže být záporné","error"),void(document.getElementById("tip").value="");document.getElementById("cart").innerHTML=cart.map((t,e)=>`<div class="cart-item"><div class="text-container text-adaptive font-medium text-white" data-fulltext="${t.name}">${t.name} (${t.quantity}x)</div><div class="flex items-center space-x-4"><button onclick="updateQuantity(${e},-1)" class="text-red-400 hover:text-red-600"><i class="fas fa-minus"></i></button><span class="text-price text-green-400">${t.price*t.quantity} Kč</span><button onclick="updateQuantity(${e},1)" class="text-green-400 hover:text-green-600"><i class="fas fa-plus"></i></button><button onclick="removeFromCart(${e})" class="text-red-400 hover:text-red-600"><i class="fas fa-trash"></i></button></div></div>`).join("");const o=cart.reduce((t,e)=>t+e.price*e.quantity,0),n=o*(1-t/100)+e;document.getElementById("total").textContent=`${Math.round(n)} Kč`};const updateQuantity=(t,e)=>{cart[t].quantity+=e,cart[t].quantity<=0&&(cart.splice(t,1),showToast("Položka odebrána z košíku")),saveCart(),updateCart()};const removeFromCart=t=>{showToast(`${cart[t].name} odebrán z košíku`),cart.splice(t,1),saveCart(),updateCart()};const saveCart=()=>localStorage.setItem("cart",JSON.stringify(cart));const saveProducts=()=>{localStorage.setItem("products",JSON.stringify(products)),displayCategories(),displayMenu(),displayProducts()};document.getElementById("clear-cart").addEventListener("click",()=>{cart.length?(cart=[],saveCart(),updateCart(),showToast("Košík vyprázdněn")):showToast("Košík je prázdný","error")}),document.getElementById("discount").addEventListener("input",updateCart),document.getElementById("tip").addEventListener("input",updateCart);const filterMenu=t=>{document.querySelectorAll(".category-tab").forEach(t=>t.classList.remove("active")),document.querySelector(`[data-category="${t}"]`).classList.add("active"),displayMenu(t,document.getElementById("search").value)};document.getElementById("search").addEventListener("input",t=>displayMenu(document.querySelector(".category-tab.active").dataset.category,t.target.value));const processPayment=(t,e=null)=>{const o=document.getElementById("notes").value,n=+document.getElementById("discount").value||0,a=+document.getElementById("tip").value||0,c=cart.reduce((t,e)=>t+e.price*e.quantity,0),s=c*(1-n/100)+a;if(!cart.length)return void showToast("Košík je prázdný!","error");showToast(`Platba ${t}: ${Math.round(s)} Kč${e&&e>s?`\nVráceno: ${(e-s).toFixed(2)} Kč`:""}`),cart=[],document.getElementById("notes").value="",document.getElementById("discount").value="",document.getElementById("tip").value="",saveCart(),updateCart()};document.getElementById("pay-cash").addEventListener("click",()=>{const t=+document.getElementById("discount").value||0,e=+document.getElementById("tip").value||0,o=cart.reduce((t,e)=>t+e.price*e.quantity,0),n=o*(1-t/100)+e;if(!cart.length)return void showToast("Košík je prázdný!","error");const a=document.getElementById("cash-modal"),c=document.getElementById("cash-total"),s=document.getElementById("cash-amount"),d=document.getElementById("cash-change");c.textContent=`${Math.round(n)} Kč`,s.value="",d.textContent="0 Kč",a.style.display="block",a.querySelector(".modal-content").classList.add("show"),s.addEventListener("input",()=>{const t=+s.value||0;d.textContent=t>n?`${(t-n).toFixed(2)} Kč`:"0 Kč"},{once:!0}),document.getElementById("confirm-cash").onclick=()=>{const t=+s.value||0;t<n?showToast("Nedostatečná částka!","error"):(processPayment("Hotovost",t),a.style.display="none")},document.getElementById("cancel-cash").onclick=()=>{a.querySelector(".modal-content").classList.remove("show"),setTimeout(()=>a.style.display="none",300)}}),document.getElementById("pay-card").addEventListener("click",()=>processPayment("Karta")),document.getElementById("print-receipt").addEventListener("click",()=>{if(!cart.length)return void showToast("Košík je prázdný!","error");const t=+document.getElementById("discount").value||0,e=+document.getElementById("tip").value||0,o=cart.reduce((t,e)=>t+e.price*e.quantity,0),n=o*(1-t/100)+e,a=document.getElementById("notes").value,c=window.open("","_blank");c.document.write(`<html><head><title>Účtenka</title><style>body{font-family:Arial,sans-serif;padding:15px;max-width:300px;margin:0 auto}h1{font-size:16px;text-align:center}table{width:100%;border-collapse:collapse;margin:10px 0}th,td{padding:5px;text-align:left}.total{font-weight:700}.notes{font-style:italic}</style></head><body><h1>Účtenka - Tapin</h1><p>Datum: ${new Date().toLocaleString("cs-CZ")}</p><table><tr><th>Položka</th><th>Množství</th><th>Cena</th></tr>${cart.map(t=>`<tr><td>${t.name}</td><td>${t.quantity}x</td><td>${t.price*t.quantity} Kč</td></tr>`).join("")}${t?`<tr><td colspan="2">Sleva (${t}%)</td><td>-${Math.round(o*t/100)} Kč</td></tr>`:""}${e?`<tr><td colspan="2">Dýško</td><td>${Math.round(e)} Kč</td></tr>`:""}<tr class="total"><td colspan="2">Celkem</td><td>${Math.round(n)} Kč</td></tr></table>${a?`<p class="notes">Poznámky: ${a}</p>`:""}<p style="text-align:center">Děkujeme za nákup na tapin.cz!</p></body></html>`),c.document.close(),c.print()}),document.getElementById("manage-products").addEventListener("click",()=>{document.getElementById("product-id").value="",document.getElementById("product-name").value="",document.getElementById("product-price").value="",document.getElementById("product-category").value="",document.getElementById("new-category").value="",document.getElementById("product-modal").style.display="block",document.getElementById("product-modal").querySelector(".modal-content").classList.add("show"),displayProducts()}),document.getElementById("save-product").addEventListener("click",()=>{const t=+document.getElementById("product-id").value,e=document.getElementById("product-name").value.trim(),o=+document.getElementById("product-price").value,n=document.getElementById("product-category").value||document.getElementById("new-category").value.trim();if(!e||!n||o<=0)return void showToast("Vyplňte všechny údaje správně","error");if(t){const a=products.find(e=>e.id===t);a&&(a.name=e,a.price=o,a.category=n)}else products.push({id:products.length?Math.max(...products.map(t=>t.id))+1:1,name:e,price:o,category:n});saveProducts(),document.getElementById("product-modal").style.display="none",showToast("Produkt uložen")}),document.getElementById("close-product").addEventListener("click",()=>{const t=document.getElementById("product-modal");t.querySelector(".modal-content").classList.remove("show"),setTimeout(()=>t.style.display="none",300)}),document.getElementById("share-config").addEventListener("click",()=>{const t=document.getElementById("share-modal"),e=document.getElementById("export-code");e.value=JSON.stringify(products,null,2),document.getElementById("share-code").value="",t.style.display="block",t.querySelector(".modal-content").classList.add("show")}),document.getElementById("import-config").addEventListener("click",()=>{try{const t=JSON.parse(document.getElementById("share-code").value);if(Array.isArray(t)&&t.every(t=>t.id&&t.name&&t.price&&t.category))products=t,saveProducts(),showToast("Pokladna importována"),document.getElementById("share-modal").style.display="none";else showToast("Neplatný kód pokladny","error")}catch(t){showToast("Neplatný kód pokladny","error")}}),document.getElementById("copy-code").addEventListener("click",()=>{const t=document.getElementById("export-code");t.select(),document.execCommand("copy"),showToast("Kód zkopírován")}),document.getElementById("close-share").addEventListener("click",()=>{const t=document.getElementById("share-modal");t.querySelector(".modal-content").classList.remove("show"),setTimeout(()=>t.style.display="none",300)}),document.getElementById("reset-pos").addEventListener("click",()=>{confirm("Opravdu chcete resetovat pokladnu? Všechny produkty a historie budou smazány.")&&(products=[],cart=[],localStorage.clear(),saveProducts(),saveCart(),updateCart(),showToast("Pokladna resetována"))}),window.editProduct=t=>{const e=products.find(e=>e.id===t);e&&(document.getElementById("product-id").value=t,document.getElementById("product-name").value=e.name,document.getElementById("product-price").value=e.price,document.getElementById("product-category").value=e.category,document.getElementById("new-category").value="",document.getElementById("product-modal").style.display="block",document.getElementById("product-modal").querySelector(".modal-content").classList.add("show"))},window.deleteProduct=t=>{products=products.filter(e=>e.id!==t),saveProducts(),showToast("Produkt smazán")},updateDate(),displayCategories(),displayMenu(),updateCart(),setInterval(updateDate,6e4);